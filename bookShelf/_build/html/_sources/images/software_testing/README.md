## 変数が複数ある場合のテスト：ドメイン分析テストとデジジョンテーブル
<a id="anchor4"></a>

これまでは数値のみのシンプル条件分岐を例で見てきましたが、実際にはより複雑な処理のテストを行うことがあります。

この場合、複雑な処理は「複数の種類、複数の変数を考慮する条件分岐」を意味します。
説明変数が1つなら単回帰、説明変数が2つ以上なら重回帰といった趣です。

複雑な処理の例として、映画のチケット発券を例にとると、最低限必要な入力は「人数(数値)」「映画タイトル(文字列)」「席の位置(座標：（数値,数値）)」となります。

このように条件が増えてくると、考慮すべきテストケースが多くなり抜け漏れが生じやすくなります。
その際に役立つ技法が**ドメイン分析テスト**と**デシジョンテーブル**です。
 
 
### ドメイン分析テストとは？
ドメイン分析テストとは、相互作用する複数の変数に対して行うテスト手法です。
筆者は「変数が増えた同値テスト・境界値テスト」という大雑把な解釈です。
また、ここでのドメインの意味は「条件で使用する値の組」として捉えています。

以下に例題をあげます
```
田中さんはある資格Aをとりたいと考えています。
資格Aを取得するには理論、実践の2つの試験で以下の条件を満たす必要があります。
各試験は100点満点です。
- 理論 >= 60
- 理論 + 実践 >= 100
```

この試験の場合、資格取得に対して変数同士（理論、実践）は相互作用しています。
言い換えると、理論の点数によって取得に必要な実践の点数が変化します。

![](https://i.imgur.com/Ao2Z2nJ.png)

上の図のような領域が合格の領域であることが想定できます。
判定したいのは理論と実践の点数の関係を考慮した上での合格不合格ですので、
このような場合にドメイン分析テストが有効です。

◆(個人的な所感)テストケースに限らず、値の関係性をグラフにすることは重要


### ドメイン分析テストで重要な4つのポイント
ドメイン分析テストの理解には4つのポイントが重要になってきます。

|ポイント|意味| x > 5|x >= 5|10 <= x <= 15|
|-|-|-|-|-|
|on|境界上の値|5|5|10,15|
|off|onポイントとは逆の結果にとなる、境界と隣接する値|6|4|9,16|
|in|条件を満たすが、onポイントではない値|7,8,...|7,8,...|11~14|
|out|条件を満たさないが、onポイントではない値|4,3,...|4,3,...|5,20,...|

offポイントはonポイントに応じて変わります。


> - onポイントが条件を満たす値なら(境界が'<='もしくは'>=')、offポイントは条件を満たさない値
> - onポイントが条件を満たさない値なら(境界が'<'もしくは'>')、offポイントは条件を満たす値
> 引用：[ソフトウェア機能テスト手法まとめ](https://qiita.com/yokoc1322/items/d7b4ad158698fd80f827)より

### ドメインテストマトリクス
今回行いたいのは次の条件を組み合わせての検証です。
```
- 理論 >= 60
- 理論 + 実践 >= 100
```
「検証は一つずつ」行うことで欠陥が他の欠陥を隠すことを避けたいです。
そこで、着目する変数の一つだけでonポイントとoffポイントを動かして、その他の変数をinポイントに入れておけば一つずつ検証する事ができます。
これを網羅的に行う際に作成するのが**ドメインテストマトリクス**です。

表：資格試験のテストケース
![](https://i.imgur.com/pnrZiFX.png)

ドメインテストマトリクスを作成することで、列にテストケースを整理できます。

◆(推奨)ドメインテストマトリクスの優しい解説はudemy動画推奨

### 演習
考え方の定着を目的として、演習問題を作って回答してみます。



## 条件が論理式で表せる場合のテスト：デシジョンテーブル
<a id="anchor5"></a>

デシジョンテーブルとは、論理関係を表形式で整理した物です。
システム設計の文書化や今回のようなテストに用いることができるツールです。

デシジョンテーブルを理解するために[Amazonの配送料](https://www.amazon.co.jp/gp/help/customer/display.html?nodeId=201911210)を例にしてテストケースを考えてみます。
Amazonでは「2000円以上の買い物をした離島以外に住む人は基本送料無料」です。

上記の例は論理式で表すことができます。
-> 2000円以上買い物をした and 離島に住んでいない

![](https://i.imgur.com/KFT7MRY.png)

今回の例をデシジョンテーブルに起こすと上記のような表になります。
作成方法は実行するアクションとアクションの実行条件をはじめに整理し、条件の状態をYes/Noで埋めていきます。

Amazonの例では条件が2つでYes/Noの2値の状態があるので2の2乗で4通りのテストケースができます。

### デシジョンテーブルの注意点
デシジョンテーブルは解釈性た良く、テストケースが作成しやすいですが、メリットデメリットは当然あります。

- メリット
    - 複数の条件の組み合わせ表であるため、どの条件がどんな状態かが明確である
    - 網羅性が定量化できる -> 網羅率 = 実地したテストケース数 / 全テストケース数
- デメリット
    - 順序は考慮されない
    - 条件が増えるとテストケース数が発散する


上記のようなデメリットはあるものの、場合によってはテストケースの圧縮が可能です。
条件の判定順序でテストケースを整理した時、条件が満たされなかったら後ろの条件判定をしなくていい物についてはそれ以降の判定を行わないようにできます。

前節のAmazon配送料のデシジョンテーブルでは、case3・4は2000以上購入を満たしていないためその時点以降の判定を行わなくて良くなります。そこで2000円以上購入Noのテストケース（case3）として実行すれば良いのです。

### 演習
考え方の定着を目的として、演習問題を作って回答してみます。

プログラミングの練習で有名なFizzBuzz問題についてのテストケースを考えてみます。
```
FizzBuzz問題

ある数字入力xが与えられた時、以下の条件で戻り値を返せ。
- xが3の倍数： Fizz
- xが5の倍数: Buzz
- xが3、5の倍数: FizzBuzz
- 上記のどれでもない: 入力値
```

デシジョンテーブルは以下のような表になります。
xは計算上あり得ないケースのため除外すると、テストケースは4つになります。
![](https://i.imgur.com/BnfKWc4.png)

テスト設計アプローチをここで考えてみます。
デシジョンテーブルで有効なテストケース（caseが割り振られている列）のみについて考える場合は契約テスト、無効なケース（caseが割り振られていない列）も含めて考える場合は防御的テストを選択することになります。

しかし、今回は無効なケースは計算上存在しないため、防御的テストを行えるテストケースが存在しません。そのため、今回は契約テストでアプローチすることになります。

ただし、論理上あり得ないことがプログラム上でもあり得ないかは別にチェックが必要であるため、ソースコードの確認はしましょう。

また、判定として「15の倍数は3と5の公倍数である」ことから別のデシジョンテーブルを作成できます。

![](https://i.imgur.com/A38Ewqd.png)


## 組み合わせによる効率的なテスト：ペア構成テスト
<a id="anchor6"></a>

これまでいくつかテスト技法、有用なツールを見てきました。
以下にテスト技法とその時想定する変数の数の個人的な感覚を整理します。

|テスト技法|変数（x）|
|-|-|
|同値クラステスト|1|
|境界値テスト|1|
|ドメイン分析テスト|x<5|
|デシジョンテーブル|x<5|

より多くの変数の組み合わせのテストを行う場合、テストケースは膨大になっていきます。
全てを網羅するのは現実的ではなく、方針の切替が必要です。
-> 少ないテストケースである程度の網羅性を確保する方針
-> 重要な組み合わせやバグがありそうな組み合わせを重点的にテスト

### ペア構成テストとは？
ペア構成テストとは、変数の全ての入力の組み合わせをテストするのではなく、変数の全てのペアをテストするテスト技法です。

全てのペアについて以下に例をあげます。
```
3枚のコイン(C1、C2、C3)で表裏（2値条件）について考える場合
- 全ての組み合わせ　2 * 2 * 2 = 8通り
- 全てのペア (C1, C2)、(C2, C3)、(C1, C3)それぞれにコインの表裏のパターン（4通り）が入る
```

上記のように全てのペアをテストすることである程度の網羅性が確保できるだろうと言えるのには理由があります。多くの欠陥は次の二つに大別できます。
1. モジュール単体が正常動作しない
2. 2つのモジュールを組み合わせた時正常動作しない

上のように大別すると、ペアにしてテストした際には2番目について検出でき、検出した欠陥を精査することでモジュール単体の異常動作についても発見できるというわけです。

詳しくはこちらの記事([ペアワイズ法は本当に有効なのか？組み合わせテスト技法と上手に付き合う方法](https://dev.classmethod.jp/articles/introduction-to-combination-testing-methods/))が参考になります。

### 直行表
直行表とは、全てのペアを抜け漏れなく網羅するためのツールです。

コインを例にすると直行表は以下のようになります。
行がテストケースで、列に条件が入ります。
![](https://i.imgur.com/xqjKUv8.png)

直行表をAとB、AとC、BとCに限定してみた時、状態の組み合わせが揃っていることがわかります。

直行表を見てパッと作るのは難しそうですが、そもそも作る必要はありません。
テスト実行者は既存の直行表から適切なものを選べれば大丈夫です。

直行表の表記法がわかれば選ぶのも難しくないと思います。
コインの例で出した直行表は4行で2値条件が3つなので「L4(2^3)」と表現されます。

8行で2値条件が1つならばL8(2^1)
5行で3値条件が4つならばL5(3^4)
9行で2値条件が4つ　3値条件が2つならばL9(2^4 3^2)

また調べる際には「[タグチ計画のカタログ](https://support.minitab.com/ja-jp/minitab/18/help-and-how-to/modeling-statistics/doe/supporting-topics/taguchi-designs/catalogue-of-taguchi-designs/)」が参考になると思います。

### 直行表の作り方
直行表の作り方を整理すると次のようになります。

1. 条件を全て把握する
2. 各条件の取り得る値を出す
3. 1と2の条件に合う直交表を選ぶ（完全一致がない場合少し大きめを選ぶ）
4. 直交表にテスト対象の条件をいれる


しかし、今回は[PICT](https://github.com/microsoft/pict)というツールを使って直行表を作成してみます。~~直行表を探すのが面倒~~

例として開発で使用するパソコンの設定でOS、言語、エディタの3条件についてのテストケースを考えてみます。

```
OS: Windows, macOS, Linux
言語: Python, Scala, Typescript
エディタ: Emacs, Atom, Vim
```

PICTで作成して直行表が次の表です。

|OS|言語|エディタ|
|-|-|-|
|Windows|Python|Emacs|
|Windows|Scala|Atom|
|Windows|Typescript|Vim|
|macOS|Python|Vim|
|macOS|Scala|Emacs|
|macOS|Typescript|Atom|
|Linux|Python|Atom|
|Linux|Scala|Vim|
|Linux|Typescript|Emacs|

### 演習
考え方の定着を目的として、演習問題を作って回答してみます。
直行表カタログは[こちら](https://support.sas.com/techsup/technote/ts723_Designs.txt)参照しました

以下の問題でテストケースを作成しましょう。
```
あるECサイトで1ヶ月後に小規模なアウトドア品セールを行う。
複数の条件で割引がされるかのテストしたいのでテストケースを洗い出して欲しい。

条件が次の通り。
- 対象カテゴリ
    リュックサック、靴、アウトドアウェア、携帯食糧、キャンプ用品、登山用品
- 消耗品かどうか
    Yes No
- 重量は5kg以上か
    Yes No
```

流れにそってやっていきます。
1. 条件は対象カテゴリ、消耗品かどうか、重量は5kg以上かの3つである。
2. 対象カテゴリが6値条件で、他が2値条件である。
3. 1と2の条件に合う直交表はL?(2^2 6^1)であるが、当てはまるのはL12(2^2 6^1)
4. 直交表にテスト対象の条件をいれる

直行表よりテストケースは全部で12個になります。


||消耗品|重量5kg以上|対象カテゴリ|
|-|-|-|-|
|1|Yes |Yes |リュックサック|
|2|Yes |Yes |アウトドアウェア|
|3|Yes |Yes |キャンプ用品|
|4|Yes |No |靴|
|5|Yes |No |携帯食糧|
|6|Yes |No |登山用品|
|7|No |Yes |靴|
|8|No |Yes |携帯食糧|
|9|No |Yes |登山用品|
|10|No |No |リュックサック|
|11|No |No |アウトドアウェア|
|12|No |No |キャンプ用品|

ちなみに以下の表はPICTを使用して作成したテストケースです。

||消耗品|  重量5kg以上|     対象カテゴリ|
|-|-|-|-|
|1|Yes     |Yes     |リュックサック|
|2|Yes     |No      |アウトドアウェア|
|3|Yes     |Yes     |キャンプ用品|
|4|Yes     |No      |靴|
|5|Yes     |No      |携帯食糧|
|6|Yes     |No      |登山用品|
|7|No      |Yes     |靴|
|8|No      |Yes     |携帯食糧|
|9|No      |Yes     |登山用品|
|10|No      |No      |リュックサック|
|11|No      |Yes     |アウトドアウェア|
|12|No      |No      |キャンプ用品|

カタログを元に作成したテストケースとPICTで作成したテストケースはほぼ同じになりました。
違う点は2,11行目重量5kg以上の値が反転しているところですが、これでも網羅できています。

## 状態変化に対応するテスト:状態遷移テスト
<a id="anchor7"></a>


これまでは条件とその取る値によって振る舞いが変わるシステムに関するテストを見てきました。
より発展的なものとして、現在の状態とその遷移（状態Aから状態Bに変化すること）によって振る舞いが変わるシステムに関するテストについて見ていきます。

状態遷移テストは二つのツールを使って次の流れで進めていきます。
1. 状態遷移図を描いて、全体を俯瞰する
2. 状態遷移表を作成して、詳細を確認する

今回はストップウォッチを例にして考えます。

ストップウォッチは次のような振る舞い（仕様）をします。
ここでスタート/ストップボタンをSB、ストップウォッチ機能をSW、リセットボタンをRBと表します。
```
- 初期状態でSWは作動していない
- 初期状態でSBを押すと、SWが作動する（時間計測が始まる）
- 作動状態でSBを押すと、SWが停止する（時間計測が停止され、その時点での秒数が表示される）
- 停止状態でSBを押すと、再びSWが作動する（時間計測が再開される）
- 停止状態でRBを押すと、初期状態になる
```

### 状態遷移図
ストップウォッチの仕様について改めて確認します。

```
ストップウォッチの仕様
スタート/ストップボタン->SB、ストップウォッチ機能->SW、リセットボタン->RB

- 初期状態でSWは作動していない
- 初期状態でSBを押すと、SWが作動する（時間計測が始まる）
- 作動状態でSBを押すと、SWが停止する（時間計測が停止され、その時点での秒数が表示される）
- 停止状態でSBを押すと、再びSWが作動する（時間計測が再開される）
- 停止状態でRBを押すと、初期状態になる
```

これを元に状態遷移図を描くと次のような図になります。
![](https://i.imgur.com/eepUiQ1.png)


状態として初期状態、作動状態、停止状態があります。また状態遷移のトリガーイベントとしてSBとRBがあり、矢印によって状態遷移の数とトリガーイベントの始状態と終状態を示しています。

状態遷移図は上手のように大雑把に状態間の関係性を描画するものです。
これを元に状態遷移を表にしてテストケースを洗い出すことになります。
テストに指針としてまずは「全ての遷移をテストすること」です。

状態遷移図では矢印の数が状態遷移の数です。
そこで最低限テストするケースは次の4つです。

- 初期状態 + SB -> 作動状態に遷移 
- 作動状態 + SB -> 停止状態に遷移
- 停止状態 + SB -> 作動状態に遷移
- 停止状態 + RB -> 初期状態に遷移

また、状態遷移図にはないが実際に操作可能な物もあります。
例えば
- 初期状態 + RB -> ?
- 作動状態 + RB -> ?

これらについては現実的に起こりうるかどうかを加味してテストケースに含めるかどうかは判断することになると思います。今回の例では誤操作として十分ありうるのでテストするべきです。
このような例は適用不可能な遷移として、NA(Not Applicable)と呼びます。


### 状態遷移表
状態遷移図は状態遷移を俯瞰し、全体像を把握するのに有効ですがNAのようなケースも漏れなく見出すのは難しいです。

そこで状態遷移表を使います。
今回の例では状態遷移表は次のようになります。
![](https://i.imgur.com/LTbjHFb.png)

状態遷移表は列の一番上が始状態を表し、イベントと直行する成分がそのイベントによる終状態を表します。NAはイベントに対応する終状態が存在しないことを示します。

状態遷移表によって仕様の抜け漏れもチェックできるのが利点です。
しかし、テストはこれで十分というわけではありません。
なぜなら、2状態の遷移については状態遷移表で網羅できていますが、3状態については記載がされていないためです。3状態の遷移とは「停止状態-> 初期状態 -> 作動状態」のような遷移です。

状態遷移に伴ってシステムの内部状態が変化してしまう場合も考慮して、状態遷移の組み合わせに関するテストも必要になります。このような場合には**Nスイッチカバレッジテスト**が有用です。

### Nスイッチカバレッジ
Nスイッチカバレッジテストは、N+1回状態遷移を網羅するパスのテストです。

今回のストップウォッチの例では、NAとなる部分は初期状態に戻るような仕様を考えることとします。

![](https://i.imgur.com/bbk8M4J.png)

作成した状態遷移表をNスイッチカバレッジのテストのために関係行列（状態の関係性を行列で表現したもの）に書き直します。この行列は始状態を行、終状態を列、トリガーイベントを成分に持ちます。

![](https://i.imgur.com/ZqoBGFM.png)


関係行列を二乗すると、

![](https://i.imgur.com/JoSiLYJ.png)

上の表の成分の表示と意味は次のように対応します。

- RS: リセットボタンを押した後、スタート/ストップボタンを押す
- RS + SR: リセットボタンを押してスタート/ストップボタンを押すか、スタート/ストップボタンを押してリセットボタンを押す

上表は1スイッチカバレッジの表です。1スイッチとは始状態から終状態までに経由する中間状態の数を指します。スイッチの数Nに対して、N+1乗するとNスイッチカバレッジの表が得られます。
今回の表では12のテストケースになります。

注意点として、Nの数が大きくなるほどテストケースが増大します。まずは状態遷移表を使ったすべての遷移の確認を行い、 その上で必要に応じてNスイッチカバレッジをNが小さい順に段階的に必要なテストを行っていくのが望ましいです。

### 演習



